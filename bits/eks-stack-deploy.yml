version: 1
commands:
- name: eks-stack-deploy
  description: Intall the EKS stack required by the pipeline.
  steps:
  - scripts:
    - >
      if [[ $NITRO_BIT_DOCKER_BUILD_ARGS ]]; then
          eval "docker build -t $NITRO_BIT_DOCKER_IMAGE_NAME:latest . $NITRO_BIT_DOCKER_BUILD_ARGS"
      else
          docker build -t $NITRO_BIT_DOCKER_IMAGE_NAME:latest .
      fi
    - docker tag $NITRO_BIT_DOCKER_IMAGE_NAME:latest $NITRO_BIT_DOCKER_REGISTRY/$NITRO_BIT_DOCKER_IMAGE_NAME:latest
    - docker push $NITRO_BIT_DOCKER_REGISTRY/$NITRO_BIT_DOCKER_IMAGE_NAME:latest
    - docker tag $NITRO_BIT_DOCKER_IMAGE_NAME:latest $NITRO_BIT_DOCKER_REGISTRY/$NITRO_BIT_DOCKER_IMAGE_NAME:$NITRO_BIT_BUILD_NUMBER
    - docker push $NITRO_BIT_DOCKER_REGISTRY/$NITRO_BIT_DOCKER_IMAGE_NAME:$NITRO_BIT_BUILD_NUMBER
    - > 
      cat <<EOF > helm.sh
        #!/bin/bash
        if [[ 1 ]]; then
          if [[ contoflow ]]; then
            helm upgrade --install contoflow "/chart/nitro-contoflow-ui" --set app.tag=2 -n contoflow
          else
            helm upgrade --install contoflow "/chart/nitro-contoflow-ui" --set app.tag=2
          fi
        fi
      EOF
    - chmod +x ./helm.sh && ./helm.sh
